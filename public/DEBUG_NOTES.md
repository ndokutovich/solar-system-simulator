# Отладка проблемы с температурной картой

## Проблема
Температурная карта не следует за солнцем корректно. Есть подозрение на "двойной поворот".

## Созданные файлы для отладки

### 1. `debug_temperature.html`
Упрощённая версия с:
- Визуализацией стрелки направления на солнце
- Упрощённым шейдером (красный = к солнцу, синий = от солнца)
- Возможностью включить авто-вращение Меркурия
- Отображением координат и направлений

**Как использовать:**
```bash
# Откройте в браузере
solar_system/debug_temperature.html
```

## Анализ проблемы

### Возможные причины:

1. **Пространство координат в шейдере**
   - `normal` в шейдере может быть в view space, а не object space
   - `sunDirection` передаём в object space
   - Несоответствие пространств координат

2. **Преобразование матриц**
   - При преобразовании направления на солнце в локальные координаты
   - Возможно, применяем инверсию дважды или не там где нужно

3. **Порядок операций в Three.js**
   - `updateMatrixWorld()` должен вызываться перед использованием матриц
   - Порядок применения трансформаций важен

## Решения для проверки

### Тест 1: Без преобразований
```javascript
// Просто передаём мировое направление
const toSun = sunPos.sub(mercuryPos).normalize();
material.uniforms.sunDirection.value = toSun;
```

### Тест 2: С правильным преобразованием
```javascript
// Обновляем матрицу
mercury.updateMatrixWorld(true);

// Получаем обратную матрицу (без вращения)
const normalMatrix = new THREE.Matrix3().getNormalMatrix(mercury.matrixWorld);
const sunDirLocal = toSun.clone().applyMatrix3(normalMatrix);
```

### Тест 3: Использование normalMatrix в шейдере
```glsl
// В vertex shader
varying vec3 vWorldNormal;
vWorldNormal = normalize((modelMatrix * vec4(normal, 0.0)).xyz);

// В fragment shader
float dotProduct = dot(vWorldNormal, sunDirection);
```

## Ключевые моменты Three.js

1. **Пространства координат:**
   - Object Space: локальные координаты объекта
   - World Space: глобальные координаты сцены
   - View Space: относительно камеры
   - Clip Space: после проекции

2. **Матрицы в Three.js:**
   - `modelMatrix`: Object → World
   - `viewMatrix`: World → View
   - `projectionMatrix`: View → Clip
   - `modelViewMatrix`: Object → View (композиция)
   - `normalMatrix`: Для трансформации нормалей

3. **Нормали в шейдерах:**
   - `normal` - в object space
   - `normalMatrix * normal` - корректная трансформация нормалей
   - Нужно нормализовать после трансформации

## Правильное решение

Для корректной работы температурной карты:

1. Вычисляем направление на солнце в мировых координатах
2. Преобразуем его в локальные координаты Меркурия используя обратную матрицу
3. В шейдере используем локальные нормали и локальное направление на солнце
4. Вычисляем dot product в одном пространстве координат

## Проверка

Откройте `debug_temperature.html` и проверьте:
- Красная сторона всегда к солнцу?
- При включении авто-вращения Меркурия карта остаётся правильной?
- Стрелка показывает правильное направление?

Если в debug версии работает, перенесите решение в основную версию.